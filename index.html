<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversor HEIC para PNG</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    <script type="module">
        import React, { useState } from 'https://esm.sh/react@18';
        import ReactDOM from 'https://esm.sh/react-dom@18/client';
        import { Upload, Download, X, Image, CheckCircle, AlertCircle } from 'https://esm.sh/lucide-react';
        
        export default function HeicToPngConverter() {
        const [files, setFiles] = useState([]);
        const [converting, setConverting] = useState(false);

        const handleFileSelect = (e) => {
            const selectedFiles = Array.from(e.target.files);
            const heicFiles = selectedFiles.filter(file => 
            file.name.toLowerCase().endsWith('.heic') || 
            file.name.toLowerCase().endsWith('.heif')
            );
            
            const newFiles = heicFiles.map(file => ({
            id: Math.random().toString(36).substr(2, 9),
            file,
            name: file.name,
            status: 'pending',
            convertedUrl: null,
            error: null
            }));
            
            setFiles(prev => [...prev, ...newFiles]);
        };

        const removeFile = (id) => {
            setFiles(prev => prev.filter(f => f.id !== id));
        };

        const convertFiles = async () => {
            setConverting(true);
            
            for (let i = 0; i < files.length; i++) {
            if (files[i].status === 'converted') continue;
            
            setFiles(prev => prev.map(f => 
                f.id === files[i].id ? { ...f, status: 'converting' } : f
            ));

            try {
                const heic2any = (await import('https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js')).default;
                
                const convertedBlob = await heic2any({
                blob: files[i].file,
                toType: 'image/png',
                quality: 1
                });

                const blob = Array.isArray(convertedBlob) ? convertedBlob[0] : convertedBlob;
                const url = URL.createObjectURL(blob);
                
                setFiles(prev => prev.map(f => 
                f.id === files[i].id 
                    ? { ...f, status: 'converted', convertedUrl: url, blob } 
                    : f
                ));
            } catch (error) {
                console.error('Erro ao converter:', error);
                setFiles(prev => prev.map(f => 
                f.id === files[i].id 
                    ? { ...f, status: 'error', error: error.message } 
                    : f
                ));
            }
            }
            
            setConverting(false);
        };

        const downloadFile = (file) => {
            if (!file.convertedUrl) return;
            
            const a = document.createElement('a');
            a.href = file.convertedUrl;
            a.download = file.name.replace(/\.(heic|heif)$/i, '.png');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        };

        const downloadAll = () => {
            files.forEach(file => {
            if (file.status === 'converted') {
                setTimeout(() => downloadFile(file), 100);
            }
            });
        };

        const clearAll = () => {
            files.forEach(file => {
            if (file.convertedUrl) {
                URL.revokeObjectURL(file.convertedUrl);
            }
            });
            setFiles([]);
        };

        const convertedCount = files.filter(f => f.status === 'converted').length;

        return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
            <div className="max-w-4xl mx-auto">
                <div className="bg-white rounded-2xl shadow-xl p-8 mb-6">
                <div className="text-center mb-8">
                    <div className="inline-flex items-center justify-center w-16 h-16 bg-indigo-100 rounded-full mb-4">
                    <ImageIcon className="w-8 h-8 text-indigo-600" />
                    </div>
                    <h1 className="text-3xl font-bold text-gray-800 mb-2">
                    Conversor HEIC para PNG
                    </h1>
                    <p className="text-gray-600">
                    Converta seus arquivos HEIC/HEIF para PNG de forma rápida e segura
                    </p>
                </div>

                <div className="mb-6">
                    <label className="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-indigo-300 rounded-xl cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 transition-all">
                    <div className="flex flex-col items-center justify-center pt-5 pb-6">
                        <Upload className="w-12 h-12 text-indigo-400 mb-3" />
                        <p className="mb-2 text-sm text-gray-700 font-medium">
                        Clique para selecionar arquivos
                        </p>
                        <p className="text-xs text-gray-500">
                        Suporta múltiplos arquivos HEIC/HEIF
                        </p>
                    </div>
                    <input
                        type="file"
                        className="hidden"
                        multiple
                        accept=".heic,.heif"
                        onChange={handleFileSelect}
                        disabled={converting}
                    />
                    </label>
                </div>

                {files.length > 0 && (
                    <>
                    <div className="space-y-3 mb-6 max-h-96 overflow-y-auto">
                        {files.map(file => (
                        <div
                            key={file.id}
                            className="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200"
                        >
                            <div className="flex items-center gap-3 flex-1 min-w-0">
                            {file.status === 'pending' && (
                                <div className="w-5 h-5 rounded-full border-2 border-gray-300" />
                            )}
                            {file.status === 'converting' && (
                                <div className="w-5 h-5 border-2 border-indigo-600 border-t-transparent rounded-full animate-spin" />
                            )}
                            {file.status === 'converted' && (
                                <CheckCircle className="w-5 h-5 text-green-500" />
                            )}
                            {file.status === 'error' && (
                                <AlertCircle className="w-5 h-5 text-red-500" />
                            )}
                            
                            <div className="flex-1 min-w-0">
                                <p className="text-sm font-medium text-gray-700 truncate">
                                {file.name}
                                </p>
                                {file.status === 'error' && (
                                <p className="text-xs text-red-500 mt-1">
                                    Erro: {file.error}
                                </p>
                                )}
                            </div>
                            </div>

                            <div className="flex items-center gap-2 ml-4">
                            {file.status === 'converted' && (
                                <button
                                onClick={() => downloadFile(file)}
                                className="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors"
                                title="Baixar arquivo"
                                >
                                <Download className="w-5 h-5" />
                                </button>
                            )}
                            {!converting && (
                                <button
                                onClick={() => removeFile(file.id)}
                                className="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                title="Remover arquivo"
                                >
                                <X className="w-5 h-5" />
                                </button>
                            )}
                            </div>
                        </div>
                        ))}
                    </div>

                    <div className="flex gap-3">
                        <button
                        onClick={convertFiles}
                        disabled={converting || files.every(f => f.status === 'converted')}
                        className="flex-1 bg-indigo-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-indigo-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                        >
                        {converting ? 'Convertendo...' : 'Converter Arquivos'}
                        </button>
                        
                        {convertedCount > 0 && (
                        <button
                            onClick={downloadAll}
                            disabled={converting}
                            className="bg-green-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                        >
                            Baixar Todos ({convertedCount})
                        </button>
                        )}
                        
                        <button
                        onClick={clearAll}
                        disabled={converting}
                        className="bg-gray-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-gray-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
                        >
                        Limpar
                        </button>
                    </div>
                    </>
                )}
                </div>

                <div className="bg-white rounded-lg shadow p-6">
                <h2 className="text-lg font-semibold text-gray-800 mb-3">
                    ℹ️ Sobre a conversão
                </h2>
                <ul className="text-sm text-gray-600 space-y-2">
                    <li>• Todos os arquivos são processados localmente no seu navegador</li>
                    <li>• Seus arquivos não são enviados para nenhum servidor</li>
                    <li>• Suporta conversão em lote de múltiplos arquivos</li>
                    <li>• Qualidade máxima preservada na conversão</li>
                </ul>
                </div>
            </div>
            </div>
        );
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(HeicToPngConverter));
    </script>
</body>
</html>