<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversor HEIC para PNG</title>
    <meta name="description" content="Converta arquivos HEIC/HEIF para PNG de forma rápida e segura">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #eff6ff 0%, #e0e7ff 100%);
            min-height: 100vh;
            padding: 1rem;
        }
        .container { max-width: 56rem; margin: 0 auto; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); padding: 2rem; margin-bottom: 1.5rem; }
        .header { text-align: center; margin-bottom: 2rem; }
        .icon-circle { 
            width: 4rem; height: 4rem; 
            background: #e0e7ff; 
            border-radius: 50%; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center;
            margin-bottom: 1rem;
        }
        h1 { font-size: 1.875rem; font-weight: 700; color: #1f2937; margin-bottom: 0.5rem; }
        .subtitle { color: #6b7280; }
        .upload-area {
            border: 2px dashed #a5b4fc;
            border-radius: 0.75rem;
            padding: 3rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 1.5rem;
        }
        .upload-area:hover { border-color: #6366f1; background: #eef2ff; }
        .upload-text { color: #374151; font-weight: 500; margin-bottom: 0.5rem; }
        .upload-subtext { color: #9ca3af; font-size: 0.75rem; }
        .file-list { max-height: 24rem; overflow-y: auto; margin-bottom: 1.5rem; }
        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
        }
        .file-info { display: flex; align-items: center; gap: 0.75rem; flex: 1; min-width: 0; }
        .file-name { color: #374151; font-weight: 500; font-size: 0.875rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .file-error { color: #dc2626; font-size: 0.75rem; margin-top: 0.25rem; }
        .file-actions { display: flex; gap: 0.5rem; margin-left: 1rem; }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: #4f46e5; color: white; flex: 1; }
        .btn-primary:hover:not(:disabled) { background: #4338ca; }
        .btn-success { background: #059669; color: white; }
        .btn-success:hover:not(:disabled) { background: #047857; }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-secondary:hover:not(:disabled) { background: #4b5563; }
        .btn-icon { 
            padding: 0.5rem;
            border: none;
            background: none;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .btn-icon:hover { background: #f3f4f6; }
        .buttons-row { display: flex; gap: 0.75rem; }
        .spinner { 
            width: 1.25rem; height: 1.25rem; 
            border: 2px solid #4f46e5; 
            border-top-color: transparent; 
            border-radius: 50%; 
            animation: spin 0.6s linear infinite; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .status-icon { width: 1.25rem; height: 1.25rem; flex-shrink: 0; }
        .info-box { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; }
        .info-title { font-size: 1.125rem; font-weight: 600; color: #1f2937; margin-bottom: 0.75rem; }
        .info-list { color: #6b7280; font-size: 0.875rem; list-style: none; }
        .info-list li { margin-bottom: 0.5rem; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="header">
                <div class="icon-circle">
                    <svg width="32" height="32" fill="none" stroke="#4f46e5" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <circle cx="8.5" cy="8.5" r="1.5"></circle>
                        <polyline points="21 15 16 10 5 21"></polyline>
                    </svg>
                </div>
                <h1>Conversor HEIC para PNG</h1>
                <p class="subtitle">Converta seus arquivos HEIC/HEIF para PNG de forma rápida e segura</p>
            </div>

            <label class="upload-area" for="fileInput">
                <svg width="48" height="48" fill="none" stroke="#a5b4fc" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24" style="margin: 0 auto 1rem;">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <p class="upload-text">Clique para selecionar arquivos</p>
                <p class="upload-subtext">Suporta múltiplos arquivos HEIC/HEIF</p>
            </label>
            <input type="file" id="fileInput" accept=".heic,.heif" multiple>

            <div id="fileList"></div>
            <div id="buttons"></div>
        </div>

        <div class="info-box">
            <h2 class="info-title">ℹ️ Sobre a conversão</h2>
            <ul class="info-list">
                <li>• Todos os arquivos são processados localmente no seu navegador</li>
                <li>• Seus arquivos não são enviados para nenhum servidor</li>
                <li>• Suporta conversão em lote de múltiplos arquivos</li>
                <li>• Qualidade máxima preservada na conversão</li>
            </ul>
        </div>
    </div>

    <script type="module">
        let files = [];
        let converting = false;

        const fileInput = document.getElementById('fileInput');
        const fileListEl = document.getElementById('fileList');
        const buttonsEl = document.getElementById('buttons');

        fileInput.addEventListener('change', (e) => {
            const selectedFiles = Array.from(e.target.files);
            const heicFiles = selectedFiles.filter(file => 
                file.name.toLowerCase().endsWith('.heic') || 
                file.name.toLowerCase().endsWith('.heif')
            );
            
            const newFiles = heicFiles.map(file => ({
                id: Math.random().toString(36).substr(2, 9),
                file,
                name: file.name,
                status: 'pending',
                convertedUrl: null,
                error: null
            }));
            
            files = [...files, ...newFiles];
            render();
            fileInput.value = '';
        });

        function removeFile(id) {
            files = files.filter(f => f.id !== id);
            render();
        }

        async function convertFiles() {
            converting = true;
            render();
            
            for (let i = 0; i < files.length; i++) {
                if (files[i].status === 'converted') continue;
                
                files[i].status = 'converting';
                render();

                try {
                    const heic2any = (await import('https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js')).default;
                    
                    const convertedBlob = await heic2any({
                        blob: files[i].file,
                        toType: 'image/png',
                        quality: 1
                    });

                    const blob = Array.isArray(convertedBlob) ? convertedBlob[0] : convertedBlob;
                    const url = URL.createObjectURL(blob);
                    
                    files[i].status = 'converted';
                    files[i].convertedUrl = url;
                    files[i].blob = blob;
                } catch (error) {
                    console.error('Erro:', error);
                    files[i].status = 'error';
                    files[i].error = error.message;
                }
                render();
            }
            
            converting = false;
            render();
        }

        function downloadFile(file) {
            if (!file.convertedUrl) return;
            const a = document.createElement('a');
            a.href = file.convertedUrl;
            a.download = file.name.replace(/\.(heic|heif)$/i, '.png');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function downloadAll() {
            files.forEach((file, i) => {
                if (file.status === 'converted') {
                    setTimeout(() => downloadFile(file), i * 100);
                }
            });
        }

        function clearAll() {
            files.forEach(file => {
                if (file.convertedUrl) URL.revokeObjectURL(file.convertedUrl);
            });
            files = [];
            render();
        }

        function render() {
            const convertedCount = files.filter(f => f.status === 'converted').length;

            if (files.length === 0) {
                fileListEl.innerHTML = '';
                buttonsEl.innerHTML = '';
                return;
            }

            fileListEl.innerHTML = `<div class="file-list">${files.map(file => `
                <div class="file-item">
                    <div class="file-info">
                        ${file.status === 'pending' ? '<div class="status-icon" style="width:1.25rem;height:1.25rem;border-radius:50%;border:2px solid #d1d5db"></div>' : ''}
                        ${file.status === 'converting' ? '<div class="spinner"></div>' : ''}
                        ${file.status === 'converted' ? '<svg class="status-icon" fill="none" stroke="#10b981" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' : ''}
                        ${file.status === 'error' ? '<svg class="status-icon" fill="none" stroke="#ef4444" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>' : ''}
                        <div style="flex:1;min-width:0">
                            <p class="file-name">${file.name}</p>
                            ${file.status === 'error' ? `<p class="file-error">Erro: ${file.error}</p>` : ''}
                        </div>
                    </div>
                    <div class="file-actions">
                        ${file.status === 'converted' ? `
                            <button class="btn-icon" onclick="window.downloadFile('${file.id}')" title="Baixar">
                                <svg width="20" height="20" fill="none" stroke="#4f46e5" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                </svg>
                            </button>
                        ` : ''}
                        ${!converting ? `
                            <button class="btn-icon" onclick="window.removeFile('${file.id}')" title="Remover">
                                <svg width="20" height="20" fill="none" stroke="#dc2626" stroke-width="2" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('')}</div>`;

            buttonsEl.innerHTML = `<div class="buttons-row">
                <button class="btn btn-primary" onclick="window.convertFiles()" ${converting || files.every(f => f.status === 'converted') ? 'disabled' : ''}>
                    ${converting ? 'Convertendo...' : 'Converter Arquivos'}
                </button>
                ${convertedCount > 0 ? `
                    <button class="btn btn-success" onclick="window.downloadAll()" ${converting ? 'disabled' : ''}>
                        Baixar Todos (${convertedCount})
                    </button>
                ` : ''}
                <button class="btn btn-secondary" onclick="window.clearAll()" ${converting ? 'disabled' : ''}>
                    Limpar
                </button>
            </div>`;
        }

        window.removeFile = (id) => removeFile(id);
        window.downloadFile = (id) => {
            const file = files.find(f => f.id === id);
            if (file) downloadFile(file);
        };
        window.convertFiles = convertFiles;
        window.downloadAll = downloadAll;
        window.clearAll = clearAll;
    </script>
</body>
</html>
